worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # --- Logging ---
    # Send logs to stdout/stderr so Railway (and Docker) can see them
    access_log /dev/stdout;
    error_log  /dev/stderr;

    # --- Gzip Compression ---
    # Compresses JSON responses before sending to the client.
    # A 10KB JSON payload might compress to 2KB.
    gzip on;
    gzip_types application/json text/plain;
    gzip_min_length 256;

    # --- Rate Limiting ---
    # Creates a "zone" that tracks request rates per client IP.
    # 10m = 10MB of shared memory for tracking (~160,000 IPs).
    # rate=10r/s = allow 10 requests per second per IP.
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # --- Upstream ---
    # Defines the backend server to forward requests to.
    # ${API_HOST} and ${API_PORT} are environment variables
    # injected at container startup (see the Dockerfile).
    upstream express_api {
        server ${API_HOST}:${API_PORT};
    }

    server {
        listen 80;
        server_name _;

        # --- Security Headers ---
        # These tell browsers to behave more securely
        add_header X-Content-Type-Options "nosniff" always;   # Don't guess MIME types
        add_header X-Frame-Options "DENY" always;             # Prevent clickjacking
        add_header X-XSS-Protection "1; mode=block" always;   # Legacy XSS filter

        # Health check — bypasses rate limiting so monitoring tools
        # don't get blocked
        location = /health {
            proxy_pass http://express_api;
        }

        # All API v1 routes — rate-limited
        location /api/v1/ {
            # burst=20 allows short spikes of up to 20 requests.
            # nodelay means excess burst requests are served immediately
            # (not queued) but still count against the limit.
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass         http://express_api;
            proxy_http_version 1.1;

            # Forward real client info to Express.
            # Without these, Express sees every request as coming from
            # Nginx's internal IP, not the actual client.
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;

            # How long Nginx waits for Express to respond
            proxy_connect_timeout 10s;
            proxy_read_timeout    30s;
            proxy_send_timeout    30s;
        }

        # Reject anything that isn't /health or /api/v1/*
        location / {
            return 404 '{"error": "Not found"}';
            add_header Content-Type application/json;
        }
    }
}